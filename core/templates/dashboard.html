{% extends 'base.html' %}


{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<style>
    body {
        background-color: #f8f9fa;
    }
    .card {
        border-radius: 1rem;
        border: none;
    }
    .card-header {
        border-top-left-radius: 1rem;
        border-top-right-radius: 1rem;
        font-weight: 600;
    }
    .btn {
        border-radius: 2rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    .btn:hover {
        transform: scale(1.03);
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .stats-card {
        border-radius: 1.25rem;
        padding: 1.5rem;
        color: white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .stats-card h5 {
        font-size: 1rem;
        font-weight: 600;
    }
    .stats-card p {
        font-size: 1.4rem;
        font-weight: bold;
        margin: 0;
    }
    table tbody tr:nth-child(even) {
        background-color: #f9f9f9;
    }
    table td, table th {
        padding: 0.75rem;
        vertical-align: middle;
    }
    .img-logo {
        width: 600rem !important;
        object-fit: cover;
    }
    /* Estilos para widgets de categoria */
    .categoria-widget {
        border-radius: 1.25rem;
        padding: 1.5rem;
        color: white;
        margin-bottom: 1rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
</style>


<div class="container-fluid py-1">
{% if messages %}
  <div class="container mt-3">
    {% for message in messages %}
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
      </div>
    {% endfor %}
  </div>
{% endif %}

    <!-- Filtros e A√ß√µes -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark text-white">Filtros e A√ß√µes</div>
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">M√™s</label>
                    <input type="number" name="mes" class="form-control rounded-pill" placeholder="1-12"
                           value="{{ form.mes.value|default:'' }}" min="1" max="12">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Ano</label>
                    <input type="number" name="ano" class="form-control rounded-pill" placeholder="Ex: 2025"
                           value="{{ form.ano.value|default:'' }}" min="2000" max="2100">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Tipo</label>
                    <select name="tipo" class="form-select rounded-pill" aria-label="Filtrar por tipo de transa√ß√£o">
                        <option value="">Selecione...</option>
                        <option value="entrada" {% if form.tipo.value == "entrada" %}selected{% endif %}>Entrada</option>
                        <option value="saida" {% if form.tipo.value == "saida" %}selected{% endif %}>Sa√≠da</option>
                    </select>
                </div>


                <div class="col-md-3">
                    <label class="form-label">Categoria</label>
                    <select name="categoria" class="form-select rounded-pill">
                        <option value="" {% if not form.categoria.data %}selected{% endif %}>Selecione...</option>
                        {% for choice in form.categoria.field.choices %}
                            {% if choice.0|add:"0" %}
                                <option value="{{ choice.0 }}"
                                    {% if choice.0 == form.categoria.data %}selected{% endif %}>
                                    {{ choice.1 }}
                                </option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <!--
                <div class="col-md-3">
                    <label class="form-label">Data In√≠cio</label>
                    <input type="date" name="data_inicio" class="form-control rounded-pill"
                           value="{{ form.data_inicio.value|date:'Y-m-d' }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Data Fim</label>
                    <input type="date" name="data_fim" class="form-control rounded-pill"
                           value="{{ form.data_fim.value|date:'Y-m-d' }}">
                </div>
                -->
                <div class="row justify-content-center g-3">
                  <div class="col-12 col-md-3 d-grid">
                    <button type="submit" class="btn btn-primary" aria-label="Filtrar por m√™s e ano">
                      <i class="bi bi-funnel-fill"></i> Filtrar
                    </button>
                  </div>
                  <div class="col-12 col-md-3 d-grid">
                    <a href="{% url 'adicionar_transacao' %}" class="btn btn-success" aria-label="Adicionar nova transa√ß√£o">
                      <i class="bi bi-plus-circle"></i> Transa√ß√£o
                    </a>
                  </div>
                  <div class="col-12 col-md-3 d-grid">
                    <a href="{% url 'contas_a_pagar' %}" class="btn btn-danger" aria-label="Visualizar contas a pagar">
                      <i class="bi bi-receipt"></i> Contas a Pagar
                    </a>
                  </div>
                </div>
            </form>

            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-3 mt-3 px-2 d-flex justify-content-center align-items-center">
            <div class="col d-grid">
                <a href="{% url 'configurar_categorias' %}" class="btn" style="border: 1px solid grey;" aria-label="Configurar categorias">
                ‚öôÔ∏è Categorias
                </a>
            </div>
            <div class="col d-grid">
                <a href="{% url 'adicionar_pagador' %}" class="btn" style="border: 1px solid grey;" aria-label="Adicionar pagador">
                <i class="bi bi-person-plus-fill"></i> Fornecedor
                </a>
            </div>
            <div class="col d-grid">
                <a href="/exportar-pdf/?mes={{ form.mes.value|default:'' }}&ano={{ form.ano.value|default:'' }}"
                   class="btn" style="border: 1px solid grey;" aria-label="Exportar relat√≥rio em PDF">
                   ‚¨áÔ∏è Exportar PDF
                </a>
            </div>
            <div class="col d-grid">
                <a href="{% url 'relatorio_financeiro' %}" class="btn" style="border: 1px solid grey;" aria-label="Visualizar relat√≥rio financeiro">
                üìä Relat√≥rio Financeiro
                </a>
            </div>
            </div>

        </div>
    </div>

    <!-- Totais Mensais -->
    <div class="row row-cols-1 row-cols-md-3 g-3 mb-4">
        <div class="col">
            <div class="stats-card bg-success text-center">
                <h5><i class="bi bi-arrow-down-circle"></i> Entradas</h5>
                <p class="valor-formatado" data-valor="{{ entradas_ultimo_mes|default_if_none:'0' }}">R$ --</p>
            </div>
        </div>
        <div class="col">
            <div class="stats-card bg-danger text-center">
                <h5><i class="bi bi-arrow-up-circle"></i> Sa√≠das</h5>
                <p class="valor-formatado" data-valor="{{ saidas_ultimo_mes|default_if_none:'0' }}">R$ {{ saidas_ultimo_mes|default_if_none:'--' }}</p>
            </div>
        </div>
        <div class="col">
            <div class="stats-card bg-info text-center">
                <h5><i class="bi bi-wallet2"></i> Saldo</h5>
                <p class="valor-formatado" data-valor="{{ saldo_ultimo_mes|default_if_none:'0' }}">R$ {{ saldo_ultimo_mes|default_if_none:'--' }}</p>
            </div>
        </div>
    </div>

    <!-- Widgets de Sa√≠das por Categoria -->
    {% if categoria_saidas and mes and ano or categoria_saidas and data_inicio and data_fim %}
    <div class="row row-cols-1 row-cols-md-3 g-3 mb-4">
        {% for cat_id, valor in categoria_saidas.items %}
        {% with cat=categorias|dictsort:"id"|first|dictsort:"id" %}
        {% if cat_id|stringformat:"s" == cat.0|stringformat:"s" %}
        <div class="col">
            <div class="categoria-widget" style="background-color: {% cycle '#FF6347' '#8B0000' %};">
                <h5><i class="bi bi-arrow-up-circle"></i> {{ cat.1 }}</h5>
                <p>R${{ valor|floatformat:2 }}</p>
            </div>
        </div>
        {% endif %}
        {% endwith %}
        {% endfor %}
        <!-- Total Geral das Sa√≠das -->
        <div class="col">
            <div class="stats-card bg-dark text-center">
                <h5><i class="bi bi-arrow-up-circle"></i> Total Sa√≠das</h5>
                <p>R${{ saidas_ultimo_mes|floatformat:2 }}</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- √öltimas Entradas e Sa√≠das lado a lado -->
    <div class="row g-4 mb-4">
        <!-- √öltimas Entradas -->
        <div class="col-12 col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white">√öltimas Entradas</div>
                <div class="card-body">
                    {% if ultimas_entradas %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Data</th>
                                    <th>Valor</th>
                                    <th>Descri√ß√£o</th>
                                    <th>Cliente/Fonte</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transacao in ultimas_entradas %}
                                <tr class="transacao-row" data-id="{{ transacao.id }}" style="cursor:pointer;">
                                    <td>{{ transacao.data|date:"d/m/Y" }}</td>
                                    <td>R${{ transacao.valor|floatformat:2 }}</td>
                                    <td>{{ transacao.descricao|default:"Sem descri√ß√£o" }}</td>
                                    <td>{{ transacao.pagador.nome|default:"Nenhum" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">Nenhuma entrada registrada.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- √öltimas Sa√≠das -->
        <div class="col-12 col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-danger text-white">√öltimas Sa√≠das</div>
                <div class="card-body">
                    {% if ultimas_saidas %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 50px;"></th>
                                    <th>Data</th>
                                    <th>Valor</th>
                                    <th>Descri√ß√£o</th>
                                    <th>Fornecedor/Pagador</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transacao in ultimas_saidas %}
                                <tr class="transacao-row" data-id="{{ transacao.id }}" style="cursor:pointer;">
                                    <td>
                                        {% if transacao.pagador.logo %}
                                        <img style="width: 100px;" src="{{ transacao.pagador.logo.url }}"
                                            alt="Logo {{ transacao.pagador.nome }}"
                                            class="img-fluid rounded-circle shadow-sm img-logo">
                                        {% else %}
                                        <span class="text-muted">Sem imagem</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ transacao.data|date:"d/m/Y" }}</td>
                                    <td>R${{ transacao.valor|floatformat:2 }}</td>
                                    <td>{{ transacao.descricao|default:"Sem descri√ß√£o" }}</td>
                                    <td>{{ transacao.pagador.nome|default:"Nenhum" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">Nenhuma sa√≠da registrada.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="text-center mt-3 d-flex align-items-center justify-content-center flex-wrap gap-2">
        <a href="?mes={{ form.mes.value }}&ano={{ form.ano.value }}&tipo=entrada" class="btn btn-outline-success rounded-pill me-2">
            Ver todas as entradas
        </a>
        <a href="?mes={{ form.mes.value }}&ano={{ form.ano.value }}&tipo=saida" class="btn btn-outline-danger rounded-pill me-2">
            Ver todas as sa√≠das
        </a>
        <a href="?mes={{ form.mes.value }}&ano={{ form.ano.value }}" class="btn btn-outline-primary rounded-pill">
            Ver todas as entradas e sa√≠das
        </a>
    </div>

</div>

<div class="modal fade" id="transacaoModal" tabindex="-1" aria-labelledby="transacaoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="post" enctype="multipart/form-data" action="" id="comprovante-form">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="transacaoModalLabel">Detalhes da Transa√ß√£o</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body" id="modal-body-content">
          <p class="text-muted">Carregando...</p>
        </div>
        <div class="modal-footer">
          <input type="file" name="documentos" multiple class="form-control me-2">
          <button type="submit" class="btn btn-outline-primary">üìé Adicionar Comprovantes</button>
          <a href="#" id="editar-link" class="btn btn-warning">‚úèÔ∏è Editar</a>
          <a href="#" id="anular-link" class="btn btn-danger">‚ùå Anular</a>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.querySelector('form').addEventListener('submit', function (e) {
    const inputs = this.querySelectorAll('select, input');
    inputs.forEach(input => {
        if (!input.value) {
            input.removeAttribute('name');
        }
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const rows = document.querySelectorAll('.transacao-row');
    const modal = new bootstrap.Modal(document.getElementById('transacaoModal'));
    const modalBody = document.getElementById('modal-body-content');
    const editarLink = document.getElementById('editar-link');
    const anularLink = document.getElementById('anular-link');
    const form = document.getElementById('comprovante-form');

    rows.forEach(row => {
        row.addEventListener('click', function () {
            const transacaoId = this.dataset.id;
            fetch(`/transacao/${transacaoId}/json/`)
                .then(response => response.json())
                .then(data => {
                    modalBody.innerHTML = `
                        <p><strong>Tipo:</strong> ${data.tipo}</p>
                        <p><strong>Valor:</strong> R$${data.valor}</p>
                        <p><strong>Data:</strong> ${data.data}</p>
                        <p><strong>Descri√ß√£o:</strong> ${data.descricao || 'Sem descri√ß√£o'}</p>
                        <p><strong>Categoria:</strong> ${data.categoria || 'N√£o definida'}</p>
                        <p><strong>Fornecedor:</strong> ${data.pagador || 'Nenhum'}</p>
                        <hr>
                        <h6>üìé Comprovantes:</h6>
                        ${data.documentos.length > 0 ? data.documentos.map(doc => `
                            <p><a href="${doc.url}" target="_blank">Documento enviado em ${doc.data_envio}</a></p>
                        `).join('') : '<p class="text-muted">Nenhum documento anexado.</p>'}
                    `;
                    editarLink.href = `/transacao/${transacaoId}/editar/`;
                    anularLink.href = `/transacao/${transacaoId}/anular/`;
                    form.action = `/transacao/${transacaoId}/adicionar-comprovante/`;
                    modal.show();
                })
                .catch(error => {
                    modalBody.innerHTML = `<p class="text-danger">Erro ao carregar transa√ß√£o.</p>`;
                    console.error(error);
                    modal.show();
                });
        });
    });
});
</script>

<script>
  document.querySelectorAll('.valor-formatado').forEach(function(el) {
    let raw = el.getAttribute('data-valor');

    // Limpa espa√ßos e substitui v√≠rgula por ponto se necess√°rio
    raw = raw.replace(',', '.').trim();

    // Converte para n√∫mero
    const valor = parseFloat(raw);

    if (!isNaN(valor)) {
      const formatado = valor.toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
      el.textContent = 'R$ ' + formatado;
    } else {
      el.textContent = 'R$ --';
    }
  });
</script>

{% endblock %}