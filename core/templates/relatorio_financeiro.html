{% extends 'base.html' %}
{% load static %}

{% block breadcrumb %}
  {% with page_title="Relat√≥rio Financeiro" %}
    {{ block.super }}
  {% endwith %}
{% endblock %}

{% block content %}
<h1 class="text-center mb-4 fw-bold m-2">üìä Relat√≥rio Financeiro - {{ ano }}</h1>

<form method="get" class="mb-4 text-center no-print">
  <label for="ano" class="form-label me-2 fs-5">Filtrar por ano:</label>
  <select name="ano" id="ano" class="form-select d-inline-block w-auto me-2">
    {% for a in anos_disponiveis %}
      <option value="{{ a }}" {% if a == ano %}selected{% endif %}>{{ a }}</option>
    {% endfor %}
  </select>
  <button type="submit" class="btn btn-outline-primary me-2">Atualizar</button>
  <button type="button" onclick="window.print()" class="btn btn-success">üñ®Ô∏è Imprimir</button>
</form>

<div class="row g-4 mb-5 justify-content-center">
  <!-- Gr√°fico de Linhas -->
  <div class="col-12 col-md-6">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <canvas id="graficoLinhas"></canvas>
      </div>
    </div>
  </div>

  <!-- Gr√°fico de Pizza -->
  <div class="col-12 col-md-6">
    <div class="card shadow-sm h-100">
      <div class="card-body d-flex justify-content-center">
        <canvas id="graficoPizza" style="max-width: 300px; max-height: 300px;"></canvas>
      </div>
    </div>
  </div>
</div>

{% if categoria_top %}
<div class="row justify-content-center mb-5">
  <div class="col-12 col-md-6">
    <div class="card border-start border-4 border-danger shadow-sm">
      <div class="card-body text-center">
        <h6 class="text-uppercase text-muted mb-2">Categoria com maior gasto</h6>
        <h4 class="fw-bold text-danger mb-1">{{ categoria_top.categoria__nome }}</h4>
        <p class="fs-5 text-dark">R${{ categoria_top.total|floatformat:2 }}</p>
      </div>
    </div>
  </div>
</div>
{% endif %}

<style media="print">
  body {
    margin: 1cm;
    font-size: 12pt;
    color: #000;
    background: none;
  }

  .no-print,
  nav,
  header,
  footer,
  .breadcrumb {
    display: none !important;
  }

  canvas {
    max-width: 100% !important;
    height: auto !important;
  }

  .card {
    box-shadow: none !important;
    border: none !important;
    page-break-inside: avoid;
  }

  .card-body {
    padding: 0 !important;
  }

  h1, h4, h5, p {
    margin-top: 10px;
    margin-bottom: 20px;
    text-align: center;
    margin-bottom: 0.5cm;
  }

  .row {
    display: block;
    width: 100%;
  }

  .col-md-6, .col-md-8, .col-lg-5 {
    width: 100% !important;
    max-width: 100% !important;
  }

  @page {
    size: A4;
    margin: 1cm;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];

const entradas = {{ entradas_por_mes|safe }};
const saidas = {{ saidas_por_mes|safe }};

new Chart(document.getElementById('graficoLinhas'), {
  type: 'line',
  data: {
    labels: meses,
    datasets: [
      {
        label: 'Entradas',
        data: entradas,
        borderColor: '#28a745',
        backgroundColor: 'rgba(40,167,69,0.2)',
        fill: true,
        tension: 0.3
      },
      {
        label: 'Sa√≠das',
        data: saidas,
        borderColor: '#dc3545',
        backgroundColor: 'rgba(220,53,69,0.2)',
        fill: true,
        tension: 0.3
      }
    ]
  },
  options: {
    responsive: true,
    plugins: {
      title: {
        display: true,
        text: 'Entradas vs Sa√≠das por M√™s',
        font: {
          size: 18
        }
      },
      legend: {
        position: 'bottom'
      }
    }
  }
});

const categorias = {{ categorias_gasto|safe }};
const labels = categorias.map(c => c.categoria__nome);
const valores = categorias.map(c => c.total);

new Chart(document.getElementById('graficoPizza'), {
  type: 'pie',
  data: {
    labels: labels,
    datasets: [{
      data: valores,
      backgroundColor: ['#007bff', '#ffc107', '#17a2b8', '#6f42c1', '#fd7e14', '#20c997']
    }]
  },
  options: {
    responsive: true,
    plugins: {
      title: {
        display: true,
        text: 'Categorias com Maior Gasto',
        font: {
          size: 18
        }
      },
      legend: {
        position: 'bottom'
      }
    }
  }
});
</script>
{% endblock %} 